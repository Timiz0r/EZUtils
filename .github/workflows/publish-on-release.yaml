name: Create releases for updated packages

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  publish:
    name: Publish ${{ matrix.package.name }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      # an awkward consequence is that dependencies might not get published
      # but nothing to do about that in a workflow
      fail-fast: false
      matrix:
        package:
          - name: com.timiz0r.ezutils.common
            path: ./src/EZUtils.Common
        #   - name: com.timiz0r.ezutils.mmdavatartools
        #     path: ./src/EZUtils.MMDAvatarTools
        #   - name: com.timiz0r.ezutils.packagemanager
        #     path: ./src/EZUtils.PackageManager
        #   - name: com.timiz0r.ezutils.repackprefab
        #     path: ./src/EZUtils.RepackPrefab
        #   - name: com.timiz0r.ezutils.windowcloser
        #     path: ./src/EZUtils.WindowCloser
        #   - name: com.timiz0r.ezutils.editorenhancements
        #     path: ./src/EZUtils.EditorEnhancements
        #   - name: com.timiz0r.ezutils.localization
        #     path: ./src/EZUtils.Localization
        #   - name: com.timiz0r.ezutils.localization.extraction
        #     path: ./src/EZUtils.Localization.Extraction
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: 'true'
    #   - name: Publish UPM package
    #     uses: ./.github/actions/publish-upm-package
    #     with:
    #       package-path: ${{ matrix.package.path }}
      - uses: ./.github/actions/publish-vpm-package
        with:
          package-path: ${{ matrix.package.path }}
  update-index:
    name: Update package index
    needs: publish
    #we allow individual package publishes to fail, but we still want to finish successful ones
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: 'true'
      - name: Get manifests
        uses: actions/download-artifact@v3
        with:
          path: vpm
      - name: Update index.json
        shell: bash
        working-directory: vpm
        run: |
          #may not be any manifests
          shopt -s nullglob

          jq -n '
          reduce inputs as $manifest (input;
            if (.repo?.packages?[$manifest.name]?.versions?[$manifest.version]? != null) then
                .
            else
                .repo.packages[$manifest.name].versions[$manifest.version] += $manifest
            end
            )' index.json Manifest-*/Manifest.json > index-working.json
          mv index-working.json index.json

          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add index.json
          git commit -m "Update VPM index.json

          $(jq -s 'map({ name, version })' Manifest-*/Manifest.json)"

          git push origin



